<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Complete Purchase | The Habit Loop</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <link rel="icon" href="logo.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  <style>
    :root {
      --bg-dark: #0D1117;
      --bg-secondary: #161B22;
      --primary-blue: #3B82F6;
      --primary-blue-hover: #60A5FA;
      --text-light: #E6EDF3;
      --text-muted: #8D96A0;
      --border-color: #30363D;
      --success-color: #28a745;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
        height: 100%;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background-color: var(--bg-dark);
      background-image: 
        radial-gradient(ellipse 50% 80% at 20% 40%, rgba(59, 130, 246, 0.15), transparent),
        radial-gradient(ellipse 50% 80% at 80% 50%, rgba(13, 17, 23, 0.15), transparent);
      color: var(--text-light);
      line-height: 1.7;
      display: flex;
      flex-direction: column;
    }

    .navbar {
      display: flex; justify-content: space-between; align-items: center; padding: 0 2rem;
      height: 70px; background-color: rgba(13, 17, 23, 0.8); backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 1000;
      flex-shrink: 0;
    }
    .logo {
      font-size: 1.5rem; font-weight: 700; text-decoration: none; color: var(--text-light);
      display: flex; align-items: center; gap: 8px;
    }
    .logo .fa-fire { color: var(--primary-blue); }

    .main-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      align-items: center;
      max-width: 1100px;
      width: 100%;
      margin: 0 auto;
      padding: 3rem 2rem;
      gap: 4rem;
      flex-grow: 1;
    }
    
    .value-props { animation: slideInLeft 0.8s ease-out; }
    @keyframes slideInLeft { from { opacity: 0; transform: translateX(-30px); } to { opacity: 1; transform: translateX(0); } }

    .value-props h1 { font-size: 2.8rem; font-weight: 800; margin-bottom: 1rem; }
    .value-props .highlight { background: linear-gradient(90deg, var(--primary-blue-hover), var(--primary-blue)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .value-props p { color: var(--text-muted); font-size: 1.1rem; margin-bottom: 2rem; max-width: 450px; }
    
    .features-list { list-style: none; padding: 0; }
    .features-list li { display: flex; align-items: flex-start; gap: 1rem; margin-bottom: 1.25rem; }
    .features-list .icon { background-color: rgba(59, 130, 246, 0.1); border: 1px solid var(--border-color); color: var(--primary-blue); width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .features-list h3 { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.25rem; }
    .features-list .desc { color: var(--text-muted); font-size: 0.9rem; }

    .checkout-card {
      background-color: rgba(22, 27, 34, 0.7); backdrop-filter: blur(20px);
      border: 1px solid var(--border-color); padding: 2.5rem; border-radius: 16px;
      animation: slideInRight 0.8s ease-out;
    }
    @keyframes slideInRight { from { opacity: 0; transform: translateX(30px); } to { opacity: 1; transform: translateX(0); } }
    
    .checkout-header { text-align: center; margin-bottom: 2rem; }
    .checkout-header h2 { font-size: 1.5rem; font-weight: 600; }

    .summary-item { display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; }
    .summary-item:not(:last-child) { border-bottom: 1px solid var(--border-color); }
    .summary-item .label { color: var(--text-muted); }
    .summary-item .value { font-weight: 600; font-size: 1.1rem; }
    .summary-total { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: baseline; font-weight: 700; }
    .summary-total .label { font-size: 1.2rem; }
    .summary-total .value { font-size: 2rem; color: var(--primary-blue); }

    #payBtn {
        width: 100%; padding: 14px; margin-top: 2rem; border: none; border-radius: 8px; font-size: 1.2rem; font-weight: 700; cursor: pointer; color: white;
        background: linear-gradient(90deg, var(--success-color), #22c55e); box-shadow: 0 5px 20px rgba(40, 167, 69, 0.2);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    #payBtn:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3); }
    #payBtn:disabled { background: #166534; cursor: not-allowed; opacity: 0.7; }
    #payBtn .fa-spinner { margin-right: 10px; }

    .secure-payment-info { text-align: center; margin-top: 1.5rem; color: var(--text-muted); font-size: 0.9rem; }
    .secure-payment-info i { color: var(--success-color); }
    .razorpay-logo { width: 100px; margin-top: 0.5rem; filter: brightness(3); }

    #message { text-align: center; font-weight: 500; min-height: 24px; color: var(--danger-red); margin-top: 1rem; }
    
    footer {
        padding: 2rem 0;
        text-align: center;
        border-top: 1px solid var(--border-color);
        background-color: var(--bg-secondary);
        flex-shrink: 0;
    }
    .footer-links {
        display: flex; justify-content: center; align-items: center;
        flex-wrap: wrap; gap: 0.75rem 1.5rem;
    }
    .footer-links a { color: var(--text-muted); text-decoration: none; font-weight: 500; transition: color 0.3s ease; }
    .footer-links a:hover { color: var(--primary-blue); text-decoration: underline; }
    .footer-links .separator { color: var(--border-color); }
    
    @media (max-width: 992px) {
        body { height: auto; }
        .main-container { grid-template-columns: 1fr; gap: 3rem; padding: 2rem 1.5rem; }
        .value-props { text-align: center; }
        .value-props p { margin-left: auto; margin-right: auto; }
        .features-list { max-width: 450px; margin: 0 auto; text-align: left;}
    }

    @media (max-width: 576px) {
        .footer-links .separator { display: none; }
        .footer-links { flex-direction: column; gap: 1rem; }
    }
  </style>
</head>
<body>

  <header class="navbar">
    <a href="index.html" class="logo"><i class="fa-solid fa-fire"></i>The Habit Loop</a>
  </header>

  <main class="main-container">
    <div class="value-props">
        <h1>Unlock Your <span class="highlight">Full Potential</span></h1>
        <p>You're investing in more than just a course—you're investing in a system designed to build a real, lasting coding habit.</p>
        <ul class="features-list">
            <li>
                <div class="icon"><i class="fa-solid fa-layer-group"></i></div>
                <div><h3>Advanced & Pro Topics</h3><p class="desc">Access our complete curriculum, including advanced data structures, algorithms, and project-based modules.</p></div>
            </li>
            <li>
                <div class="icon"><i class="fa-solid fa-star"></i></div>
                <div><h3>Priority Support</h3><p class="desc">Get faster responses from our team for any questions or technical issues you encounter.</p></div>
            </li>
            <li>
                <div class="icon"><i class="fa-solid fa-infinity"></i></div>
                <div><h3>Lifetime Access</h3><p class="desc">Pay once and get lifetime access to the course content and all future updates. No recurring fees.</p></div>
            </li>
        </ul>
    </div>

    <div class="checkout-card">
      <div class="checkout-header"><h2>Complete Your Purchase</h2></div>
      <div class="order-summary">
        <div class="summary-item"><span class="label">Course</span><span class="value" id="courseName">Loading...</span></div>
        <div class="summary-item"><span class="label">Access</span><span class="value">Lifetime</span></div>
        <div class="summary-total"><span class="label">You Pay</span><span class="value" id="coursePrice">...</span></div>
      </div>
      <div id="message"></div>
      <button id="payBtn"><i class="fa-solid fa-lock"></i> Pay Securely Now</button>
      <div class="secure-payment-info"><img src="https://razorpay.com/assets/razorpay-logo-white.svg" alt="Razorpay" class="razorpay-logo"></div>
    </div>
  </main>

  <footer>
    <div class="container">
      <div class="footer-links">
        <a href="terms.html">Terms & Conditions</a><span class="separator">|</span>
        <a href="privacy.html">Privacy Policy</a><span class="separator">|</span>
        <a href="refund.html">Refund Policy</a><span class="separator">|</span>
        <a href="contact_us.html">Contact Us</a>
      </div>
    </div>
  </footer>

    <script>
    const token = localStorage.getItem('token');
    if (!token) {
        alert('You must be logged in to make a purchase.');
        window.location.href = 'login.html';
    }

    const payBtn = document.getElementById('payBtn');
    const messageEl = document.getElementById('message');

    // --- ✅✅✅ UPDATED DYNAMIC INFO LOGIC ✅✅✅ ---
    const params = new URLSearchParams(window.location.search);
    const level = params.get('level');
    const language = params.get('language');
    const priceFromUrl = params.get('price');

    const prices = { 'Advanced': 99, 'Pro': 299, 'Bundle': 199 };
    const price = prices[level] || priceFromUrl;
    
    let isValid = false;
    let displayName = "Invalid Course";

    // Handle the special "Bundle" case
    if (level === 'Bundle' && price) {
        displayName = 'Full Access Bundle';
        document.getElementById('courseName').textContent = displayName;
        document.getElementById('coursePrice').textContent = `₹${price}`;
        isValid = true;
    } 
    // Handle the standard single course cases
    else if (level && language && price) {
        displayName = `${level} ${language}`;
        document.getElementById('courseName').textContent = displayName;
        document.getElementById('coursePrice').textContent = `₹${price}`;
        isValid = true;
    }
    
    if (!isValid) {
        messageEl.textContent = 'Invalid course details. Please go back and select a course.';
        payBtn.disabled = true;
    }

    // --- THE REST OF THE SCRIPT IS UNCHANGED ---
    payBtn.addEventListener('click', async () => {
        payBtn.disabled = true;
        payBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';
        messageEl.textContent = '';
        
        try {
            const orderRes = await fetch('/api/user/create-order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ level })
            });
            const orderData = await orderRes.json();
            if (!orderRes.ok) throw new Error(orderData.message || 'Could not create order.');

            const userRes = await fetch('/api/user/me', { headers: { 'Authorization': `Bearer ${token}` } });
            if (!userRes.ok) {
              alert('Your session has expired. Please log in again.');
              localStorage.removeItem('token');
              window.location.href = 'login.html';
              return;
            }
            const userData = await userRes.json();
            
            const options = {
                key: orderData.keyId,
                amount: orderData.amount,
                currency: "INR",
                name: "The Habit Loop",
                description: `Payment for ${displayName}`,
                order_id: orderData.orderId,
                handler: async function (response) {
                    payBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Verifying...';
                    try {
                        const scheduleParams = new URLSearchParams(window.location.search);
                        const verificationRes = await fetch('/api/user/verify-payment', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                            body: JSON.stringify({
                                ...response,
                                language: scheduleParams.get('language'), // Will be null for bundle, backend handles this
                                level: scheduleParams.get('level'),
                                deliveryTime: scheduleParams.get('deliveryTime'),
                                whatsapp: scheduleParams.get('whatsapp'),
                                timeZone: scheduleParams.get('timeZone'),
                            })
                        });
                        
                        if (!verificationRes.ok) {
                            const verificationData = await verificationRes.json();
                            throw new Error(verificationData.message || 'Payment verification failed.');
                        }
                        
                        window.location.href = 'success.html';
                    } catch (verifyError) {
                        messageEl.textContent = `Verification Failed: ${verifyError.message}`;
                        payBtn.disabled = false;
                        payBtn.innerHTML = '<i class="fa-solid fa-lock"></i> Pay Securely Now';
                    }
                },
                prefill: {
                    name: userData.name || '',
                    email: userData.email || '',
                    contact: userData.whatsapp || ''
                },
                theme: { color: "#3B82F6" }
            };

            const rzp = new Razorpay(options);
            rzp.on('payment.failed', (response) => {
                messageEl.textContent = `Payment Failed: ${response.error.description}`;
                payBtn.disabled = false;
                payBtn.innerHTML = '<i class="fa-solid fa-lock"></i> Pay Securely Now';
            });

            rzp.open();
            // After rzp.open() is called, we don't re-enable the button in 'finally'
            // because the modal is now open. It's handled in the handlers.
            
        } catch (error) {
            messageEl.textContent = `Error: ${error.message}`;
            payBtn.disabled = false;
            payBtn.innerHTML = '<i class="fa-solid fa-lock"></i> Pay Securely Now';
        }
    });
  </script>
</body>
</html>